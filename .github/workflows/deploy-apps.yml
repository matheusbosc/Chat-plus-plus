name: Chat++ Build & Deploy

# Trigger manually or on push/pull_request to main
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:  # Manual trigger button

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      # 1. Checkout repo
      - uses: actions/checkout@v3

      # 2. Cache vcpkg
      - name: Cache vcpkg
        uses: actions/cache@v3
        with:
          path: ~/.vcpkg
          key: vcpkg-${{ matrix.os }}-${{ hashFiles('**/vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ matrix.os }}-

      # 3. Setup CMake 4.11+ on Linux/Windows
      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          version: "4.11.1"

      # 4. Install Ninja
      - name: Install Ninja (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y ninja-build build-essential

      - name: Install Ninja (Windows)
        if: runner.os == 'Windows'
        run: choco install ninja -y

      # 5. Create build directory
      - name: Create build directory
        run: mkdir -p build

      # 6. Configure CMake
      - name: CMake configure
        run: cmake -B build -G Ninja -S .

      # 7. Detect CPU cores for parallel builds
      - name: Detect CPU cores
        id: cores
        run: |
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            echo "cores=$(nproc)" >> $GITHUB_OUTPUT
          else
            echo "cores=${NUMBER_OF_PROCESSORS}" >> $GITHUB_OUTPUT
          fi

      # 8. Build server
      - name: Build server
        run: cmake --build build --target server -- -j ${{ steps.cores.outputs.cores }}

      # 9. Build client
      - name: Build client
        run: cmake --build build --target client -- -j ${{ steps.cores.outputs.cores }}

      # 10. List generated binaries
      - name: List binaries
        run: ls -l build

      # 11. Upload binaries
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: chatpp-binaries-${{ matrix.os }}
          path: build/
